<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Party Roulette</title>
<style>
  :root { --bg:#0b0f17; --card:#131a29; --text:#e7edf5; --muted:#9fb0c7; }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -200px,#121a2b,#0b0f17 60%);color:var(--text);display:flex;min-height:100svh}
  .wrap{margin:auto;display:grid;gap:16px;max-width:720px;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);padding:16px}
  h1{margin:0 0 8px;font-size:24px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,label{background:#0e1524;color:var(--text);border:1px solid #202a3f;border-radius:12px;padding:10px 12px}
  input{flex:1;min-width:220px}
  button{cursor:pointer;border:none;background:#1c2742}
  button:active{transform:translateY(1px)}
  .wheel-wrap{position:relative;display:grid;place-items:center}
  canvas{width:min(92vw,540px);height:min(92vw,540px)}
  .marker{position:absolute;top:8px;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-top:18px solid #e8eefb;filter:drop-shadow(0 2px 0 rgba(0,0,0,.5))}
  .result{font-size:18px;color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #253252;border-radius:999px;font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  code{background:#0e1524;padding:2px 6px;border-radius:6px;border:1px solid #202a3f}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Party Roulette üéØ</h1>
    <div class="row">
      <input id="names" placeholder="Comma-separated (e.g., Kyle, Safe, Julian, Lucky_Spot)" />
      <button id="saveNames">Save</button>
      <button id="shuffle">Shuffle</button>
      <label class="badge"><input type="checkbox" id="sound" style="accent-color:#8fb3ff;margin:0" checked /> sound</label>
      <label class="badge"><input type="checkbox" id="remove" style="accent-color:#8fb3ff;margin:0" /> remove on hit</label>
      <label class="badge"><input type="checkbox" id="sixlock" style="accent-color:#8fb3ff;margin:0" checked /> 6-chamber lock</label>
    </div>
    <div class="muted" style="margin-top:6px">
      Tip: share this link; the page reads <code>?names=Alex,Bea,Chris</code> automatically.
    </div>
  </div>

  <div class="card wheel-wrap">
    <div class="marker"></div>
    <canvas id="wheel" width="600" height="600"></canvas>
    <div class="row" style="margin-top:12px">
      <button id="spin">Spin</button>
      <button id="nuke">Clear Winner</button>
    </div>
    <div id="status" class="result" style="text-align:center;margin-top:8px">Ready.</div>
  </div>

  <div class="card">
    <div class="muted">House rules: If it lands on your name, take a shot. Hydrate. Be nice. ‚ù§Ô∏è</div>
  </div>
</div>

<!-- sounds -->
<audio id="sndGun"   preload="auto" src="gunshot.mp3"></audio>
<audio id="sndSafe"  preload="auto" src="safe.mp3"></audio>
<audio id="sndClick" preload="auto" src="click.mp3"></audio>
<audio id="sndLucky" preload="auto" src="lucky.mp3"></audio> <!-- optional -->

<script>
(function(){
  const $ = s => document.querySelector(s);
  const wheel = $("#wheel"), ctx = wheel.getContext("2d");
  const namesInput = $("#names");
  const status = $("#status");
  const soundToggle = $("#sound");
  const removeOnHit = $("#remove");
  const sixLock = $("#sixlock");

  const snd = {
    gun:   $("#sndGun"),
    safe:  $("#sndSafe"),
    click: $("#sndClick"),
    lucky: $("#sndLucky"),
  };

  // DPI crispness
  function fitDPI(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const cssW = wheel.clientWidth, cssH = wheel.clientHeight;
    wheel.width = Math.round(cssW * dpr);
    wheel.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  window.addEventListener('resize', ()=>{ fitDPI(); draw(); });

  // names
  const params = new URLSearchParams(location.search);
  const urlNames = params.get("names");
  const LS_KEY = "party_roulette_names_v3";
  let names = [];

  function parseNames(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
  function loadNames(){
    if(urlNames){ names = parseNames(urlNames); localStorage.setItem(LS_KEY, JSON.stringify(names)); }
    else{
      const saved = localStorage.getItem(LS_KEY);
      names = saved ? JSON.parse(saved) : ["Julian","Safe","Kyle","Lucky_Spot","None","Safe"];
    }
    namesInput.value = names.join(", ");
  }
  function saveNames(){
    names = parseNames(namesInput.value);
    localStorage.setItem(LS_KEY, JSON.stringify(names));
    draw();
    status.textContent = `Saved ${names.length} names.`;
  }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  // 6-chamber normalization
  function normalizedNames(){
    let arr = [...names];
    if(sixLock.checked){
      if(arr.length < 6){
        while(arr.length < 6) arr.push("Safe");
      } else if(arr.length > 6){
        arr = arr.slice(0,6);
      }
    }
    return arr;
  }

  // visual + logic helpers
  let startAngle = -Math.PI/2; // marker at top

  function keyOf(label){
    return (label||"").toLowerCase().replace(/[_-]/g," ").replace(/\s+/g," ").trim();
  }
  function classOf(label){
    const k = keyOf(label);
    if(k === "safe") return "safe";
    if(k === "none" || k === "no shot" || k === "no-shot" || k === "noshot") return "none";
    if(k.startsWith("lucky")) return "lucky";
    return "shot";
  }

  function draw(){
    const arr = normalizedNames();
    const n = arr.length;
    const W = wheel.clientWidth, H = wheel.clientHeight;
    const cx = W/2, cy = H/2;
    const R = Math.min(W,H)/2 - 10;
    ctx.clearRect(0,0,W,H);

    if(n===0){
      ctx.fillStyle="#9fb0c7"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="18px system-ui";
      ctx.fillText("Add names to play", cx, cy); return;
    }

    // --- BACK PLATE (steel)
    const base = ctx.createRadialGradient(cx, cy, R*0.15, cx, cy, R);
    base.addColorStop(0, "#596374");
    base.addColorStop(0.45, "#435064");
    base.addColorStop(1, "#2a3344");
    ctx.beginPath(); ctx.arc(cx, cy, R, 0, Math.PI*2); ctx.fillStyle = base; ctx.fill();

    // bevel rim
    ctx.lineWidth = 10;
    ctx.strokeStyle = "rgba(255,255,255,0.09)";
    ctx.beginPath(); ctx.arc(cx, cy, R-5, 0, Math.PI*2); ctx.stroke();
    ctx.strokeStyle = "rgba(0,0,0,0.45)";
    ctx.beginPath(); ctx.arc(cx, cy, R-13, 0, Math.PI*2); ctx.stroke();

    // highlight chamber at marker
    const slice = (Math.PI*2)/n;
    const chamberR = R*0.18;
    const ringR = R*0.62;
    const hitIdx = nameIndexAtMarker(arr);
    if(hitIdx !== null){
      const a = startAngle + hitIdx*slice + slice/2;
      const hx = cx + ringR*Math.cos(a);
      const hy = cy + ringR*Math.sin(a);
      ctx.beginPath(); ctx.arc(hx, hy, chamberR+9, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.08)"; ctx.fill();
    }

    // chambers
    for(let i=0;i<n;i++){
      const label = arr[i];
      const type = classOf(label);
      const a = startAngle + i*slice + slice/2;
      const x = cx + ringR*Math.cos(a);
      const y = cy + ringR*Math.sin(a);

      // bore
      const bore = ctx.createRadialGradient(x, y, 2, x, y, chamberR);
      bore.addColorStop(0, "#0b0f16");
      bore.addColorStop(0.6, "#0f1422");
      bore.addColorStop(1, "#0a0f18");
      ctx.beginPath(); ctx.arc(x, y, chamberR, 0, Math.PI*2); ctx.fillStyle = bore; ctx.fill();

      // rim
      ctx.lineWidth = 2; ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.beginPath(); ctx.arc(x, y, chamberR-3, 0, Math.PI*2); ctx.stroke();

      // if "shot" chamber, draw brass round inside
      if(type === "shot"){
        const shell = ctx.createRadialGradient(x, y, 2, x, y, chamberR*0.72);
        shell.addColorStop(0, "#f2d99a");
        shell.addColorStop(0.5, "#c9a866");
        shell.addColorStop(1, "#a4854d");
        ctx.beginPath(); ctx.arc(x, y, chamberR*0.72, 0, Math.PI*2); ctx.fillStyle = shell; ctx.fill();
        // primer dot
        ctx.beginPath(); ctx.arc(x, y, chamberR*0.14, 0, Math.PI*2); ctx.fillStyle = "#5d4b2a"; ctx.fill();
      }

      // tiny highlight
      ctx.beginPath(); ctx.arc(x - chamberR*0.35, y - chamberR*0.35, 3.3, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.25)"; ctx.fill();

      // label
      ctx.fillStyle = "#e7edf5";
      ctx.font = "13px system-ui";
      ctx.textAlign = "center"; ctx.textBaseline = "top";
      ctx.fillText(label, x, y + chamberR + 6);
    }

    // extractor star (center)
    const starR = R*0.22, teeth=6;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(startAngle*0.15); // subtle offset to look mechanical
    ctx.fillStyle = "#202838"; ctx.strokeStyle="rgba(0,0,0,0.55)"; ctx.lineWidth=3;
    ctx.beginPath();
    for(let i=0;i<teeth;i++){
      const a0 = (i/teeth)*Math.PI*2;
      const a1 = a0 + Math.PI/teeth;
      const r1 = starR*0.55, r2 = starR;
      ctx.lineTo(Math.cos(a0)*r1, Math.sin(a0)*r1);
      ctx.lineTo(Math.cos(a1)*r2, Math.sin(a1)*r2);
    }
    ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.restore();

    // center cap
    ctx.beginPath(); ctx.arc(cx, cy, starR*0.55, 0, Math.PI*2);
    const cap = ctx.createRadialGradient(cx, cy, 2, cx, cy, starR*0.55);
    cap.addColorStop(0, "#3a4456"); cap.addColorStop(1, "#1d2536");
    ctx.fillStyle = cap; ctx.fill();
    ctx.lineWidth = 2; ctx.strokeStyle = "rgba(255,255,255,0.08)"; ctx.stroke();

    // screws (at 0¬∞ and 180¬∞)
    const screwR = R*0.07;
    [[cx+R*0.7, cy],[cx-R*0.7, cy]].forEach(([sx,sy])=>{
      ctx.beginPath(); ctx.arc(sx,sy,screwR,0,Math.PI*2);
      const sg = ctx.createRadialGradient(sx, sy, 2, sx, sy, screwR);
      sg.addColorStop(0,"#5a6474"); sg.addColorStop(1,"#2a3344");
      ctx.fillStyle = sg; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle="rgba(0,0,0,0.6)"; ctx.stroke();
      // cross slot
      ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,0.35)";
      ctx.beginPath(); ctx.moveTo(sx-screwR*0.7, sy); ctx.lineTo(sx+screwR*0.7, sy); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sx, sy-screwR*0.7); ctx.lineTo(sx, sy+screwR*0.7); ctx.stroke();
    });
  }

  // spin
  let spinning = false;
  function fairRandomAngle(){
    const arr = normalizedNames();
    const n = arr.length;
    const slice = (Math.PI*2)/n;
    const targetIndex = Math.floor(Math.random()*n);
    const offset = (Math.random()-0.5)*slice*0.9;
    const targetAngle = startAngle + targetIndex*slice + slice/2 + offset;
    const final = -Math.PI/2 - (targetAngle - startAngle);
    const extra = Math.PI*2*(4 + Math.floor(Math.random()*2)); // 4-5 spins
    return startAngle + final + extra;
  }

  function spin(){
    if(spinning || normalizedNames().length===0) return;
    spinning = true; status.textContent = "Spinning‚Ä¶";
    const begin = performance.now(), from = startAngle, to = fairRandomAngle();
    const duration = 3800 + Math.random()*800;

    (function anim(t0){
      const t = (t0 - begin) / duration;
      const e = t<0 ? 0 : t>1 ? 1 : t;
      const k = 1 - Math.pow(1-e, 3); // easeOutCubic
      startAngle = from + (to - from)*k;
      draw();
      if(e < 1){ requestAnimationFrame(anim); }
      else{
        spinning = false;
        const arr = normalizedNames();
        const hit = currentNameAtMarker(arr);
        const typ = classOf(hit);
        status.innerHTML = (typ==="safe"||typ==="none")
          ? `üòÖ <b>${hit}</b> ‚Äî safe.`
          : (typ==="lucky" ? `üçÄ <b>${hit}</b> ‚Äî lucky!` : `‚ò†Ô∏è <b>${hit}</b> ‚Äî take a shot!`);

        if(soundToggle.checked){
          let audio = snd.gun;
          if(typ==="safe")  audio = snd.safe;
          else if(typ==="none") audio = snd.click;
          else if(typ==="lucky" && snd.lucky?.src) audio = snd.lucky;
          audio.currentTime = 0;
          audio.play().catch(()=>{});
        }
        if(removeOnHit.checked){
          const arr0 = [...names]; // remove matching one instance
          const idx = arr0.findIndex(n => n === hit);
          if(idx >= 0) arr0.splice(idx,1);
          names = arr0;
          namesInput.value = names.join(", ");
          localStorage.setItem(LS_KEY, JSON.stringify(names));
          setTimeout(()=>draw(), 400);
        }
      }
    })(performance.now());
  }

  function nameIndexAtMarker(arr){
    if(!arr || arr.length===0) return null;
    const slice = (Math.PI*2)/arr.length;
    const relative = ((-Math.PI/2) - startAngle) % (Math.PI*2);
    const norm = (relative + Math.PI*2) % (Math.PI*2);
    return Math.floor(norm / slice);
  }
  function currentNameAtMarker(arr){ const idx = nameIndexAtMarker(arr); return idx===null ? "" : normalizedNames()[idx]; }

  // wires
  $("#spin").addEventListener("click", spin);
  $("#saveNames").addEventListener("click", saveNames);
  $("#shuffle").addEventListener("click", ()=>{ names = shuffle(names); namesInput.value = names.join(", "); localStorage.setItem(LS_KEY, JSON.stringify(names)); draw(); });
  $("#nuke").addEventListener("click", ()=> status.textContent="Ready.");
  sixLock.addEventListener("change", draw);

  // init
  fitDPI(); loadNames(); draw();
})();
</script>
</body>
</html>
