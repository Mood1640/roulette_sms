<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Party Roulette</title>
<style>
  :root { --bg:#0b0f17; --card:#131a29; --text:#e7edf5; --muted:#9fb0c7; }
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial}
  body{margin:0;background:linear-gradient(180deg,#0b0f17,#0b0f17 50%,#0f1625);color:var(--text);display:flex;min-height:100svh}
  .wrap{margin:auto;display:grid;gap:16px;max-width:720px;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.3);padding:16px}
  h1{margin:0 0 8px;font-size:24px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button,textarea,select{background:#0e1524;color:var(--text);border:1px solid #202a3f;border-radius:12px;padding:10px 12px}
  button{cursor:pointer;border:none;background:#1c2742}
  button:active{transform:translateY(1px)}
  .wheel-wrap{position:relative;display:grid;place-items:center}
  canvas{width:min(92vw,480px);height:min(92vw,480px)}
  .marker{position:absolute;top:8px;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-top:18px solid #d9e2f1;filter:drop-shadow(0 2px 0 rgba(0,0,0,.5))}
  .result{font-size:18px;color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #253252;border-radius:999px;font-size:13px;color:var(--muted)}
  .list{width:100%}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Party Roulette üéØ</h1>
    <div class="row">
      <input id="names" class="list" placeholder="Comma-separated names (e.g., Alex, Bea, Chris)" />
      <button id="saveNames">Save</button>
      <button id="shuffle">Shuffle</button>
      <label class="badge"><input type="checkbox" id="sound" style="accent-color:#8fb3ff;margin:0" checked /> sound</label>
      <label class="badge"><input type="checkbox" id="remove" style="accent-color:#8fb3ff;margin:0" /> remove on hit</label>
    </div>
    <div class="muted" style="margin-top:6px">
      Tip: share this link; the page reads <code>?names=Alex,Bea,Chris</code> automatically.
    </div>
  </div>

  <div class="card wheel-wrap">
    <div class="marker"></div>
    <canvas id="wheel" width="500" height="500"></canvas>
    <div class="row" style="margin-top:12px">
      <button id="spin">Spin</button>
      <button id="nuke">Clear Winner</button>
    </div>
    <div id="status" class="result" style="text-align:center;margin-top:8px">Ready.</div>
  </div>

  <div class="card">
    <div class="muted">House rules: If it lands on your name, take a shot. Hydrate. Be nice. ‚ù§Ô∏è</div>
  </div>
</div>

<audio id="bang" preload="auto" src="gunshot.mp3"></audio>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const wheel = $("#wheel"), ctx = wheel.getContext("2d");
  const namesInput = $("#names");
  const status = $("#status");
  const soundToggle = $("#sound");
  const removeOnHit = $("#remove");
  const bang = $("#bang");

  // Load names from URL or localStorage
  const params = new URLSearchParams(location.search);
  const urlNames = params.get("names");
  const LS_KEY = "party_roulette_names_v1";
  let names = [];

  function parseNames(str){
    return (str||"")
      .split(",")
      .map(s=>s.trim())
      .filter(Boolean);
  }

  function loadNames(){
    if(urlNames){
      names = parseNames(urlNames);
      localStorage.setItem(LS_KEY, JSON.stringify(names));
    } else {
      const saved = localStorage.getItem(LS_KEY);
      names = saved ? JSON.parse(saved) : ["Alice","Bob","Charlie","Dana"];
    }
    namesInput.value = names.join(", ");
  }

  function saveNames(){
    names = parseNames(namesInput.value);
    localStorage.setItem(LS_KEY, JSON.stringify(names));
    draw();
    status.textContent = `Saved ${names.length} names.`;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  // Draw the wheel
  let startAngle = -Math.PI/2; // so the marker points to top
  function draw(){
    const n = names.length;
    const W = wheel.width, H = wheel.height;
    const cx = W/2, cy = H/2, r = Math.min(W,H)/2 - 12;

    ctx.clearRect(0,0,W,H);

    if(n===0){
      ctx.fillStyle="#9fb0c7";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.font="18px system-ui";
      ctx.fillText("Add names to play", cx, cy);
      return;
    }

    // draw slices
    const slice = (Math.PI*2)/n;
    for(let i=0;i<n;i++){
      const a0 = startAngle + i*slice;
      const a1 = a0 + slice;
      // alternating subtle colors without hardcoding exact hues
      ctx.fillStyle = i%2 ? "#1b2440" : "#233055";
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();
      ctx.fill();

      // labels
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate((a0+a1)/2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#e7edf5";
      ctx.font = "16px system-ui";
      ctx.fillText(names[i], r-10, 4);
      ctx.restore();
    }

    // center button circle
    ctx.beginPath();
    ctx.arc(cx,cy,60,0,Math.PI*2);
    ctx.fillStyle="#0e1524";
    ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle="#253252"; ctx.stroke();

    ctx.fillStyle="#e7edf5"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.font="bold 16px system-ui";
    ctx.fillText("SPIN", cx, cy);
  }

  // Spin logic
  let spinning = false;
  function fairRandomAngle(){
    // random target slice + random offset within slice so all names are equally likely
    const n = names.length;
    const slice = (Math.PI*2)/n;
    const targetIndex = Math.floor(Math.random()*n);
    const offset = (Math.random()-0.5)*slice*0.9; // stay within slice
    const targetAngle = startAngle + targetIndex*slice + slice/2 + offset;
    // we want that angle to end up at the marker (top). Current rotation maps slice positions,
    // so compute final rotation that puts targetAngle at -PI/2 (top/marker).
    const final = -Math.PI/2 - (targetAngle - startAngle);
    // add multiple full spins for drama
    const extra = Math.PI*2*(4 + Math.floor(Math.random()*2)); // 4-5 spins
    return startAngle + final + extra;
  }

  function spin(){
    if(spinning || names.length===0) return;
    spinning = true;
    status.textContent = "Spinning‚Ä¶";

    const begin = performance.now();
    const from = startAngle;
    const to = fairRandomAngle();
    const duration = 3800 + Math.random()*800;

    (function anim(t0){
      const t = (t0 - begin) / duration;
      const e = t<0 ? 0 : t>1 ? 1 : t;
      // easeOutCubic
      const k = 1 - Math.pow(1-e, 3);
      startAngle = from + (to - from)*k;
      draw();
      if(e < 1){
        requestAnimationFrame(anim);
      } else {
        spinning = false;
        const hit = currentNameAtMarker();
        status.innerHTML = `‚ò†Ô∏è <b>${hit}</b> ‚Äî take a shot!`;
        if(soundToggle.checked){
          bang.currentTime = 0;
          bang.play().catch(()=>{/* autoplay block ignored */});
        }
        if(removeOnHit.checked){
          names = names.filter(n => n !== hit);
          namesInput.value = names.join(", ");
          localStorage.setItem(LS_KEY, JSON.stringify(names));
          setTimeout(()=>draw(), 400);
        }
      }
    })(performance.now());
  }

  function currentNameAtMarker(){
    const n = names.length;
    const slice = (Math.PI*2)/n;
    // Angle at marker is -PI/2 in canvas space; map back to index
    const relative = ((-Math.PI/2) - startAngle) % (Math.PI*2);
    const norm = (relative + Math.PI*2) % (Math.PI*2);
    const idx = Math.floor(norm / slice);
    return names[idx];
  }

  // wires
  $("#spin").addEventListener("click", spin);
  $("#saveNames").addEventListener("click", saveNames);
  $("#shuffle").addEventListener("click", ()=>{
    names = shuffle(names);
    namesInput.value = names.join(", ");
    localStorage.setItem(LS_KEY, JSON.stringify(names));
    draw();
  });
  $("#nuke").addEventListener("click", ()=> status.textContent="Ready.");

  // init
  loadNames();
  draw();
})();
</script>
</body>
</html>
